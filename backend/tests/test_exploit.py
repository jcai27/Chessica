import pytest
import chess
from unittest.mock import MagicMock, patch
from app.opponent_model import ProfileService
from app.models import OpponentProfileModel, SessionModel
from app.search import ExploitSearch

@pytest.fixture
def mock_db():
    return MagicMock()

def test_profile_service_get_profile(mock_db):
    service = ProfileService(mock_db)
    mock_db.get.return_value = None
    
    profile = service.get_profile("user123")
    
    assert profile["style"]["tactical"] == 0.5
    assert mock_db.add.called

def test_profile_service_update_profile(mock_db):
    service = ProfileService(mock_db)
    mock_profile = OpponentProfileModel(
        user_id="user123", 
        style_vector={"tactical": 0.5}, 
        motif_risks={"early_blunder": 0.0},
        games_played=0
    )
    mock_db.get.return_value = mock_profile
    
    mock_session = SessionModel(winner="engine", moves=[{}, {}]) # Short game
    
    service.update_profile("user123", mock_session)
    
    assert mock_profile.games_played == 1
    assert mock_profile.motif_risks["early_blunder"] > 0.0 # Should increase risk

@patch("app.search._get_engine")
def test_exploit_search(mock_get_engine, mock_db):
    # Mock engine analysis
    mock_engine = MagicMock()
    mock_get_engine.return_value = mock_engine
    
    # Setup candidates: Move A is best objectively, Move B is slightly worse but tricky
    mock_engine.analyse.return_value = [
        {"pv": [chess.Move.from_uci("e2e4")], "score": chess.engine.PovScore(chess.engine.Cp(50), chess.WHITE)},
        {"pv": [chess.Move.from_uci("d2d4")], "score": chess.engine.PovScore(chess.engine.Cp(40), chess.WHITE)},
    ]
    
    profile_service = MagicMock()
    # Predict high error for d2d4 (Move B)
    profile_service.predict_error_probability.side_effect = lambda uid, fen, move: 0.8 if move == "d2d4" else 0.1
    
    searcher = ExploitSearch(profile_service)
    board = chess.Board()
    
    best_move, score, confidence = searcher.search(board, "user123")
    
    # Should pick d2d4 because 40 + (0.8 * 200) = 200 > 50 + (0.1 * 200) = 70
    assert best_move == "d2d4"
    assert confidence == 0.8
